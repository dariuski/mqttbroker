/*! mqtt-packet 9.0.0 */
import e from"events";var r={};var t=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}},s={exports:{}};!function(e){const r=s.exports;r.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},r.requiredHeaderFlags={1:0,2:0,4:0,5:0,6:2,7:0,8:2,9:0,10:2,11:0,12:0,13:0,14:0,15:0},r.requiredHeaderFlagsErrors={};for(const e in r.requiredHeaderFlags){const t=r.requiredHeaderFlags[e];r.requiredHeaderFlagsErrors[e]="Invalid header flag bits, must be 0x"+t.toString(16)+" for "+r.types[e]+" packet"}r.codes={};for(const e in r.types){const t=r.types[e];r.codes[t]=e}r.CMD_SHIFT=4,r.CMD_MASK=240,r.DUP_MASK=8,r.QOS_MASK=3,r.QOS_SHIFT=1,r.RETAIN_MASK=1,r.VARBYTEINT_MASK=127,r.VARBYTEINT_FIN_MASK=128,r.VARBYTEINT_MAX=268435455,r.SESSIONPRESENT_MASK=1,r.SESSIONPRESENT_HEADER=Buffer.from([r.SESSIONPRESENT_MASK]),r.CONNACK_HEADER=Buffer.from([r.codes.connack<<r.CMD_SHIFT]),r.USERNAME_MASK=128,r.PASSWORD_MASK=64,r.WILL_RETAIN_MASK=32,r.WILL_QOS_MASK=24,r.WILL_QOS_SHIFT=3,r.WILL_FLAG_MASK=4,r.CLEAN_SESSION_MASK=2,r.CONNECT_HEADER=Buffer.from([r.codes.connect<<r.CMD_SHIFT]),r.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},r.propertiesCodes={};for(const e in r.properties){const t=r.properties[e];r.propertiesCodes[t]=e}function t(e){return[0,1,2].map((t=>[0,1].map((s=>[0,1].map((i=>{const n=Buffer.alloc(1);return n.writeUInt8(r.codes[e]<<r.CMD_SHIFT|(s?r.DUP_MASK:0)|t<<r.QOS_SHIFT|i,0,!0),n}))))))}r.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},r.PUBLISH_HEADER=t("publish"),r.SUBSCRIBE_HEADER=t("subscribe"),r.SUBSCRIBE_OPTIONS_QOS_MASK=3,r.SUBSCRIBE_OPTIONS_NL_MASK=1,r.SUBSCRIBE_OPTIONS_NL_SHIFT=2,r.SUBSCRIBE_OPTIONS_RAP_MASK=1,r.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,r.SUBSCRIBE_OPTIONS_RH_MASK=3,r.SUBSCRIBE_OPTIONS_RH_SHIFT=4,r.SUBSCRIBE_OPTIONS_RH=[0,16,32],r.SUBSCRIBE_OPTIONS_NL=4,r.SUBSCRIBE_OPTIONS_RAP=8,r.SUBSCRIBE_OPTIONS_QOS=[0,1,2],r.UNSUBSCRIBE_HEADER=t("unsubscribe"),r.ACKS={unsuback:t("unsuback"),puback:t("puback"),pubcomp:t("pubcomp"),pubrel:t("pubrel"),pubrec:t("pubrec")},r.SUBACK_HEADER=Buffer.from([r.codes.suback<<r.CMD_SHIFT]),r.VERSION3=Buffer.from([3]),r.VERSION4=Buffer.from([4]),r.VERSION5=Buffer.from([5]),r.VERSION131=Buffer.from([131]),r.VERSION132=Buffer.from([132]),r.QOS=[0,1,2].map((e=>Buffer.from([e]))),r.EMPTY={pingreq:Buffer.from([r.codes.pingreq<<4,0]),pingresp:Buffer.from([r.codes.pingresp<<4,0]),disconnect:Buffer.from([r.codes.disconnect<<4,0])},r.MQTT5_PUBACK_PUBREC_CODES={0:"Success",16:"No matching subscribers",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",144:"Topic Name invalid",145:"Packet identifier in use",151:"Quota exceeded",153:"Payload format invalid"},r.MQTT5_PUBREL_PUBCOMP_CODES={0:"Success",146:"Packet Identifier not found"},r.MQTT5_SUBACK_CODES={0:"Granted QoS 0",1:"Granted QoS 1",2:"Granted QoS 2",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use",151:"Quota exceeded",158:"Shared Subscriptions not supported",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},r.MQTT5_UNSUBACK_CODES={0:"Success",17:"No subscription existed",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use"},r.MQTT5_DISCONNECT_CODES={0:"Normal disconnection",4:"Disconnect with Will Message",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",135:"Not authorized",137:"Server busy",139:"Server shutting down",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},r.MQTT5_AUTH_CODES={0:"Success",24:"Continue authentication",25:"Re-authenticate"}}();var i=s.exports;class n{constructor(){this._bufs=[],this.length=0}append(e){if(null==e)return this;if(e.buffer)this._appendBuffer(Buffer.from(e.buffer,e.byteOffset,e.byteLength));else if(Array.isArray(e))for(let r=0;r<e.length;r++)this.append(e[r]);else if(this._isBufferList(e))for(let r=0;r<e._bufs.length;r++)this.append(e._bufs[r]);else"number"==typeof e&&(e=e.toString()),this._appendBuffer(Buffer.from(e));return this}consume(e){if(e=Math.trunc(e),Number.isNaN(e)||e<=0)return this;for(;this._bufs.length;){if(!(e>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(e),this.length-=e;break}e-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this}readUInt8(e=0){return this.slice(e,e+1).readUInt8(0)}readUInt16BE(e=0){return this.slice(e,e+2).readUInt16BE(0)}readUInt32BE(e=0){return this.slice(e,e+4).readUInt32BE(0)}slice(e,r){return"number"==typeof e&&e<0&&(e+=this.length),"number"==typeof r&&r<0&&(r+=this.length),this.copy(null,0,e,r)}copy(e,r,t,s){if(("number"!=typeof t||t<0)&&(t=0),("number"!=typeof s||s>this.length)&&(s=this.length),t>=this.length)return e||Buffer.alloc(0);if(s<=0)return e||Buffer.alloc(0);const i=!!e,n=this._offset(t),o=s-t;let a=o,u=i&&r||0,p=n[1];if(0===t&&s===this.length){if(!i)return 1===this._bufs.length?this._bufs[0]:Buffer.concat(this._bufs,this.length);for(let r=0;r<this._bufs.length;r++)this._bufs[r].copy(e,u),u+=this._bufs[r].length;return e}if(a<=this._bufs[n[0]].length-p)return i?this._bufs[n[0]].copy(e,r,p,p+a):this._bufs[n[0]].slice(p,p+a);i||(e=Buffer.allocUnsafe(o));for(let r=n[0];r<this._bufs.length;r++){const t=this._bufs[r].length-p;if(!(a>t)){this._bufs[r].copy(e,u,p,p+a),u+=t;break}this._bufs[r].copy(e,u,p),u+=t,a-=t,p&&(p=0)}return e.length>u?e.slice(0,u):e}toString(e,r,t){return this.slice(r,t).toString(e)}_offset(e){if(0===e)return[0,0];let r=0;for(let t=0;t<this._bufs.length;t++){const s=r+this._bufs[t].length;if(e<s||t===this._bufs.length-1)return[t,e-r];r=s}}_appendBuffer(e){this._bufs.push(e),this.length+=e.length}_isBufferList(e){return e instanceof n}}const{EventEmitter:o}=e,a=t,u=i;class p extends o{constructor(){super(),this.parser=this.constructor.parser}static parser(e){return this instanceof p?(this.settings=e||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new p).parser(e)}_resetState(){this.packet=new a,this.error=null,this._list=new n,this._stateCounter=0}parse(e){for(this.error&&this._resetState(),this._list.append(e);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,this._stateCounter>=this._states.length&&(this._stateCounter=0);return this._list.length}_parseHeader(){const e=this._list.readUInt8(0),r=e>>u.CMD_SHIFT;this.packet.cmd=u.types[r];const t=15&e,s=u.requiredHeaderFlags[r];return null!=s&&t!==s?this._emitError(new Error(u.requiredHeaderFlagsErrors[r])):(this.packet.retain=0!=(e&u.RETAIN_MASK),this.packet.qos=e>>u.QOS_SHIFT&u.QOS_MASK,this.packet.qos>2?this._emitError(new Error("Packet must not have both QoS bits set to 1")):(this.packet.dup=0!=(e&u.DUP_MASK),this._list.consume(1),!0))}_parseLength(){const e=this._parseVarByteNum(!0);return e&&(this.packet.length=e.value,this._list.consume(e.bytes)),!!e}_parsePayload(){let e=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}e=!0}return e}_parseConnect(){let e,r,t,s;const i={},n=this.packet,o=this._parseString();if(null===o)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==o&&"MQIsdp"!==o)return this._emitError(new Error("Invalid protocolId"));if(n.protocolId=o,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(n.protocolVersion=this._list.readUInt8(this._pos),n.protocolVersion>=128&&(n.bridgeMode=!0,n.protocolVersion=n.protocolVersion-128),3!==n.protocolVersion&&4!==n.protocolVersion&&5!==n.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(1&this._list.readUInt8(this._pos))return this._emitError(new Error("Connect flag bit 0 must be 0, but got 1"));i.username=this._list.readUInt8(this._pos)&u.USERNAME_MASK,i.password=this._list.readUInt8(this._pos)&u.PASSWORD_MASK,i.will=this._list.readUInt8(this._pos)&u.WILL_FLAG_MASK;const a=!!(this._list.readUInt8(this._pos)&u.WILL_RETAIN_MASK),p=(this._list.readUInt8(this._pos)&u.WILL_QOS_MASK)>>u.WILL_QOS_SHIFT;if(i.will)n.will={},n.will.retain=a,n.will.qos=p;else{if(a)return this._emitError(new Error("Will Retain Flag must be set to zero when Will Flag is set to 0"));if(p)return this._emitError(new Error("Will QoS must be set to zero when Will Flag is set to 0"))}if(n.clean=0!=(this._list.readUInt8(this._pos)&u.CLEAN_SESSION_MASK),this._pos++,n.keepalive=this._parseNum(),-1===n.keepalive)return this._emitError(new Error("Packet too short"));if(5===n.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(n.properties=e)}const l=this._parseString();if(null===l)return this._emitError(new Error("Packet too short"));if(n.clientId=l,i.will){if(5===n.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(n.will.properties=e)}if(e=this._parseString(),null===e)return this._emitError(new Error("Cannot parse will topic"));if(n.will.topic=e,r=this._parseBuffer(),null===r)return this._emitError(new Error("Cannot parse will payload"));n.will.payload=r}if(i.username){if(s=this._parseString(),null===s)return this._emitError(new Error("Cannot parse username"));n.username=s}if(i.password){if(t=this._parseBuffer(),null===t)return this._emitError(new Error("Cannot parse password"));n.password=t}return this.settings=n,n}_parseConnack(){const e=this.packet;if(this._list.length<1)return null;const r=this._list.readUInt8(this._pos++);if(r>1)return this._emitError(new Error("Invalid connack flags, bits 7-1 must be set to 0"));if(e.sessionPresent=!!(r&u.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?e.reasonCode=this._list.readUInt8(this._pos++):e.reasonCode=0;else{if(this._list.length<2)return null;e.returnCode=this._list.readUInt8(this._pos++)}if(-1===e.returnCode||-1===e.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}}_parsePublish(){const e=this.packet;if(e.topic=this._parseString(),null===e.topic)return this._emitError(new Error("Cannot parse topic"));if(!(e.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}e.payload=this._list.slice(this._pos,e.length)}}_parseSubscribe(){const e=this.packet;let r,t,s,i,n,o,a;if(e.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}if(e.length<=0)return this._emitError(new Error("Malformed subscribe, no payload specified"));for(;this._pos<e.length;){if(r=this._parseString(),null===r)return this._emitError(new Error("Cannot parse topic"));if(this._pos>=e.length)return this._emitError(new Error("Malformed Subscribe Payload"));if(t=this._parseByte(),5===this.settings.protocolVersion){if(192&t)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-6 must be 0"))}else if(252&t)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-2 must be 0"));if(s=t&u.SUBSCRIBE_OPTIONS_QOS_MASK,s>2)return this._emitError(new Error("Invalid subscribe QoS, must be <= 2"));if(o=0!=(t>>u.SUBSCRIBE_OPTIONS_NL_SHIFT&u.SUBSCRIBE_OPTIONS_NL_MASK),n=0!=(t>>u.SUBSCRIBE_OPTIONS_RAP_SHIFT&u.SUBSCRIBE_OPTIONS_RAP_MASK),i=t>>u.SUBSCRIBE_OPTIONS_RH_SHIFT&u.SUBSCRIBE_OPTIONS_RH_MASK,i>2)return this._emitError(new Error("Invalid retain handling, must be <= 2"));a={topic:r,qos:s},5===this.settings.protocolVersion?(a.nl=o,a.rap=n,a.rh=i):this.settings.bridgeMode&&(a.rh=0,a.rap=!0,a.nl=!0),e.subscriptions.push(a)}}}_parseSuback(){const e=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}if(e.length<=0)return this._emitError(new Error("Malformed suback, no payload specified"));for(;this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(5===this.settings.protocolVersion){if(!u.MQTT5_SUBACK_CODES[e])return this._emitError(new Error("Invalid suback code"))}else if(e>2&&128!==e)return this._emitError(new Error("Invalid suback QoS, must be 0, 1, 2 or 128"));this.packet.granted.push(e)}}}_parseUnsubscribe(){const e=this.packet;if(e.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}if(e.length<=0)return this._emitError(new Error("Malformed unsubscribe, no payload specified"));for(;this._pos<e.length;){const r=this._parseString();if(null===r)return this._emitError(new Error("Cannot parse topic"));e.unsubscriptions.push(r)}}}_parseUnsuback(){const e=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if((3===this.settings.protocolVersion||4===this.settings.protocolVersion)&&2!==e.length)return this._emitError(new Error("Malformed unsuback, payload length must be 2"));if(e.length<=0)return this._emitError(new Error("Malformed unsuback, no payload specified"));if(5===this.settings.protocolVersion){const r=this._parseProperties();for(Object.getOwnPropertyNames(r).length&&(e.properties=r),e.granted=[];this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(!u.MQTT5_UNSUBACK_CODES[e])return this._emitError(new Error("Invalid unsuback code"));this.packet.granted.push(e)}}}_parseConfirmation(){const e=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion){if(e.length>2)switch(e.reasonCode=this._parseByte(),this.packet.cmd){case"puback":case"pubrec":if(!u.MQTT5_PUBACK_PUBREC_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"));break;case"pubrel":case"pubcomp":if(!u.MQTT5_PUBREL_PUBCOMP_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"))}else e.reasonCode=0;if(e.length>3){const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}}return!0}_parseDisconnect(){const e=this.packet;if(5===this.settings.protocolVersion){this._list.length>0?(e.reasonCode=this._parseByte(),u.MQTT5_DISCONNECT_CODES[e.reasonCode]||this._emitError(new Error("Invalid disconnect reason code"))):e.reasonCode=0;const r=this._parseProperties();Object.getOwnPropertyNames(r).length&&(e.properties=r)}return!0}_parseAuth(){const e=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));if(e.reasonCode=this._parseByte(),!u.MQTT5_AUTH_CODES[e.reasonCode])return this._emitError(new Error("Invalid auth reason code"));const r=this._parseProperties();return Object.getOwnPropertyNames(r).length&&(e.properties=r),!0}_parseMessageId(){const e=this.packet;return e.messageId=this._parseNum(),null!==e.messageId||(this._emitError(new Error("Cannot parse messageId")),!1)}_parseString(e){const r=this._parseNum(),t=r+this._pos;if(-1===r||t>this._list.length||t>this.packet.length)return null;const s=this._list.toString("utf8",this._pos,t);return this._pos+=r,s}_parseStringPair(){return{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const e=this._parseNum(),r=e+this._pos;if(-1===e||r>this._list.length||r>this.packet.length)return null;const t=this._list.slice(this._pos,r);return this._pos+=e,t}_parseNum(){if(this._list.length-this._pos<2)return-1;const e=this._list.readUInt16BE(this._pos);return this._pos+=2,e}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const e=this._list.readUInt32BE(this._pos);return this._pos+=4,e}_parseVarByteNum(e){let r,t=0,s=1,i=0,n=!1;const o=this._pos?this._pos:0;for(;t<4&&o+t<this._list.length;){if(r=this._list.readUInt8(o+t++),i+=s*(r&u.VARBYTEINT_MASK),s*=128,0==(r&u.VARBYTEINT_FIN_MASK)){n=!0;break}if(this._list.length<=t)break}return!n&&4===t&&this._list.length>=t&&this._emitError(new Error("Invalid variable byte integer")),o&&(this._pos+=t),n=!!n&&(e?{bytes:t,value:i}:i),n}_parseByte(){let e;return this._pos<this._list.length&&(e=this._list.readUInt8(this._pos),this._pos++),e}_parseByType(e){switch(e){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){const e=this._parseVarByteNum(),r=this._pos+e,t={};for(;this._pos<r;){const e=this._parseByte();if(!e)return this._emitError(new Error("Cannot parse property code type")),!1;const r=u.propertiesCodes[e];if(!r)return this._emitError(new Error("Unknown property")),!1;if("userProperties"!==r)t[r]?(Array.isArray(t[r])||(t[r]=[t[r]]),t[r].push(this._parseByType(u.propertiesTypes[r]))):t[r]=this._parseByType(u.propertiesTypes[r]);else{t[r]||(t[r]=Object.create(null));const e=this._parseByType(u.propertiesTypes[r]);if(t[r][e.name])if(Array.isArray(t[r][e.name]))t[r][e.name].push(e.value);else{const s=t[r][e.name];t[r][e.name]=[s],t[r][e.name].push(e.value)}else t[r][e.name]=e.value}}return t}_newPacket(){return this.packet&&(this._list.consume(this.packet.length),this.emit("packet",this.packet)),this.packet=new a,this._pos=0,!0}_emitError(e){this.error=e,this.emit("error",e)}}var l=p;const c={},f=Buffer.isBuffer(Buffer.from([1,2]).subarray(0,1));function h(e){const r=Buffer.allocUnsafe(2);return r.writeUInt8(e>>8,0),r.writeUInt8(255&e,1),r}var _={cache:c,generateCache:function(){for(let e=0;e<65536;e++)c[e]=h(e)},generateNumber:h,genBufVariableByteInt:function(e){let r=0,t=0;const s=Buffer.allocUnsafe(4);do{r=e%128|0,(e=e/128|0)>0&&(r|=128),s.writeUInt8(r,t++)}while(e>0&&t<4);return e>0&&(t=0),f?s.subarray(0,t):s.slice(0,t)},generate4ByteBuffer:function(e){const r=Buffer.allocUnsafe(4);return r.writeUInt32BE(e,0),r}};const d=i,b=Buffer.allocUnsafe(0),g=Buffer.from([0]),S=_,m=process.nextTick,E=S.cache,I=S.generateNumber,y=S.generateCache,w=S.genBufVariableByteInt,B=S.generate4ByteBuffer;let v=M,A=!0;function k(e,r,t){switch(r.cork&&(r.cork(),m(O,r)),A&&(A=!1,y()),e.cmd){case"connect":return function(e,r,t){const s=e||{},i=s.protocolId||"MQTT";let n=s.protocolVersion||4;const o=s.will;let a=s.clean;const u=s.keepalive||0,p=s.clientId||"",l=s.username,c=s.password,f=s.properties;void 0===a&&(a=!0);let h,_,b=0;if(!i||"string"!=typeof i&&!Buffer.isBuffer(i))return r.destroy(new Error("Invalid protocolId")),!1;b+=i.length+2;if(3!==n&&4!==n&&5!==n)return r.destroy(new Error("Invalid protocol version")),!1;b+=1;if(("string"==typeof p||Buffer.isBuffer(p))&&(p||n>=4)&&(p||a))b+=Buffer.byteLength(p)+2;else{if(n<4)return r.destroy(new Error("clientId must be supplied before 3.1.1")),!1;if(1*a==0)return r.destroy(new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof u||u<0||u>65535||u%1!=0)return r.destroy(new Error("Invalid keepalive")),!1;b+=2;if(b+=1,5===n){if(h=L(r,f),!h)return!1;b+=h.length}if(o){if("object"!=typeof o)return r.destroy(new Error("Invalid will")),!1;if(!o.topic||"string"!=typeof o.topic)return r.destroy(new Error("Invalid will topic")),!1;if(b+=Buffer.byteLength(o.topic)+2,b+=2,o.payload){if(!(o.payload.length>=0))return r.destroy(new Error("Invalid will payload")),!1;"string"==typeof o.payload?b+=Buffer.byteLength(o.payload):b+=o.payload.length}if(_={},5===n){if(_=L(r,o.properties),!_)return!1;b+=_.length}}let g=!1;if(null!=l){if(!Q(l))return r.destroy(new Error("Invalid username")),!1;g=!0,b+=Buffer.byteLength(l)+2}if(null!=c){if(!g)return r.destroy(new Error("Username is required to use password")),!1;if(!Q(c))return r.destroy(new Error("Invalid password")),!1;b+=H(c)+2}r.write(d.CONNECT_HEADER),C(r,b),R(r,i),s.bridgeMode&&(n+=128);r.write(131===n?d.VERSION131:132===n?d.VERSION132:4===n?d.VERSION4:5===n?d.VERSION5:d.VERSION3);let S=0;S|=null!=l?d.USERNAME_MASK:0,S|=null!=c?d.PASSWORD_MASK:0,S|=o&&o.retain?d.WILL_RETAIN_MASK:0,S|=o&&o.qos?o.qos<<d.WILL_QOS_SHIFT:0,S|=o?d.WILL_FLAG_MASK:0,S|=a?d.CLEAN_SESSION_MASK:0,r.write(Buffer.from([S])),v(r,u),5===n&&h.write();R(r,p),o&&(5===n&&_.write(),T(r,o.topic),R(r,o.payload));null!=l&&R(r,l);null!=c&&R(r,c);return!0}(e,r);case"connack":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=5===s?i.reasonCode:i.returnCode,o=i.properties;let a=2;if("number"!=typeof n)return r.destroy(new Error("Invalid return code")),!1;let u=null;if(5===s){if(u=L(r,o),!u)return!1;a+=u.length}r.write(d.CONNACK_HEADER),C(r,a),r.write(i.sessionPresent?d.SESSIONPRESENT_HEADER:g),r.write(Buffer.from([n])),null!=u&&u.write();return!0}(e,r,t);case"publish":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.qos||0,o=i.retain?d.RETAIN_MASK:0,a=i.topic,u=i.payload||b,p=i.messageId,l=i.properties;let c=0;if("string"==typeof a)c+=Buffer.byteLength(a)+2;else{if(!Buffer.isBuffer(a))return r.destroy(new Error("Invalid topic")),!1;c+=a.length+2}Buffer.isBuffer(u)?c+=u.length:c+=Buffer.byteLength(u);if(n&&"number"!=typeof p)return r.destroy(new Error("Invalid messageId")),!1;n&&(c+=2);let f=null;if(5===s){if(f=L(r,l),!f)return!1;c+=f.length}r.write(d.PUBLISH_HEADER[n][i.dup?1:0][o?1:0]),C(r,c),v(r,H(a)),r.write(a),n>0&&v(r,p);null!=f&&f.write();return r.write(u)}(e,r,t);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.cmd||"puback",o=i.messageId,a=i.dup&&"pubrel"===n?d.DUP_MASK:0;let u=0;const p=i.reasonCode,l=i.properties;let c=5===s?3:2;"pubrel"===n&&(u=1);if("number"!=typeof o)return r.destroy(new Error("Invalid messageId")),!1;let f=null;if(5===s&&"object"==typeof l){if(f=K(r,l,t,c),!f)return!1;c+=f.length}r.write(d.ACKS[n][u][a][0]),3===c&&(c+=0!==p?1:-1);C(r,c),v(r,o),5===s&&2!==c&&r.write(Buffer.from([p]));null!==f?f.write():4===c&&r.write(Buffer.from([0]));return!0}(e,r,t);case"subscribe":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.dup?d.DUP_MASK:0,o=i.messageId,a=i.subscriptions,u=i.properties;let p=0;if("number"!=typeof o)return r.destroy(new Error("Invalid messageId")),!1;p+=2;let l=null;if(5===s){if(l=L(r,u),!l)return!1;p+=l.length}if("object"!=typeof a||!a.length)return r.destroy(new Error("Invalid subscriptions")),!1;for(let e=0;e<a.length;e+=1){const t=a[e].topic,i=a[e].qos;if("string"!=typeof t)return r.destroy(new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof i)return r.destroy(new Error("Invalid subscriptions - invalid qos")),!1;if(5===s){if("boolean"!=typeof(a[e].nl||!1))return r.destroy(new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(a[e].rap||!1))return r.destroy(new Error("Invalid subscriptions - invalid Retain as Published")),!1;const t=a[e].rh||0;if("number"!=typeof t||t>2)return r.destroy(new Error("Invalid subscriptions - invalid Retain Handling")),!1}p+=Buffer.byteLength(t)+2+1}r.write(d.SUBSCRIBE_HEADER[1][n?1:0][0]),C(r,p),v(r,o),null!==l&&l.write();let c=!0;for(const e of a){const t=e.topic,i=e.qos,n=+e.nl,o=+e.rap,a=e.rh;let u;T(r,t),u=d.SUBSCRIBE_OPTIONS_QOS[i],5===s&&(u|=n?d.SUBSCRIBE_OPTIONS_NL:0,u|=o?d.SUBSCRIBE_OPTIONS_RAP:0,u|=a?d.SUBSCRIBE_OPTIONS_RH[a]:0),c=r.write(Buffer.from([u]))}return c}(e,r,t);case"suback":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.messageId,o=i.granted,a=i.properties;let u=0;if("number"!=typeof n)return r.destroy(new Error("Invalid messageId")),!1;u+=2;if("object"!=typeof o||!o.length)return r.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<o.length;e+=1){if("number"!=typeof o[e])return r.destroy(new Error("Invalid qos vector")),!1;u+=1}let p=null;if(5===s){if(p=K(r,a,t,u),!p)return!1;u+=p.length}r.write(d.SUBACK_HEADER),C(r,u),v(r,n),null!==p&&p.write();return r.write(Buffer.from(o))}(e,r,t);case"unsubscribe":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.messageId,o=i.dup?d.DUP_MASK:0,a=i.unsubscriptions,u=i.properties;let p=0;if("number"!=typeof n)return r.destroy(new Error("Invalid messageId")),!1;p+=2;if("object"!=typeof a||!a.length)return r.destroy(new Error("Invalid unsubscriptions")),!1;for(let e=0;e<a.length;e+=1){if("string"!=typeof a[e])return r.destroy(new Error("Invalid unsubscriptions")),!1;p+=Buffer.byteLength(a[e])+2}let l=null;if(5===s){if(l=L(r,u),!l)return!1;p+=l.length}r.write(d.UNSUBSCRIBE_HEADER[1][o?1:0][0]),C(r,p),v(r,n),null!==l&&l.write();let c=!0;for(let e=0;e<a.length;e++)c=T(r,a[e]);return c}(e,r,t);case"unsuback":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.messageId,o=i.dup?d.DUP_MASK:0,a=i.granted,u=i.properties,p=i.cmd,l=0;let c=2;if("number"!=typeof n)return r.destroy(new Error("Invalid messageId")),!1;if(5===s){if("object"!=typeof a||!a.length)return r.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<a.length;e+=1){if("number"!=typeof a[e])return r.destroy(new Error("Invalid qos vector")),!1;c+=1}}let f=null;if(5===s){if(f=K(r,u,t,c),!f)return!1;c+=f.length}r.write(d.ACKS[p][l][o][0]),C(r,c),v(r,n),null!==f&&f.write();5===s&&r.write(Buffer.from(a));return!0}(e,r,t);case"pingreq":case"pingresp":return function(e,r,t){return r.write(d.EMPTY[e.cmd])}(e,r);case"disconnect":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.reasonCode,o=i.properties;let a=5===s?1:0,u=null;if(5===s){if(u=K(r,o,t,a),!u)return!1;a+=u.length}r.write(Buffer.from([d.codes.disconnect<<4])),C(r,a),5===s&&r.write(Buffer.from([n]));null!==u&&u.write();return!0}(e,r,t);case"auth":return function(e,r,t){const s=t?t.protocolVersion:4,i=e||{},n=i.reasonCode,o=i.properties;let a=5===s?1:0;5!==s&&r.destroy(new Error("Invalid mqtt version for auth packet"));const u=K(r,o,t,a);if(!u)return!1;a+=u.length,r.write(Buffer.from([d.codes.auth<<4])),C(r,a),r.write(Buffer.from([n])),null!==u&&u.write();return!0}(e,r,t);default:return r.destroy(new Error("Unknown command")),!1}}function O(e){e.uncork()}Object.defineProperty(k,"cacheNumbers",{get:()=>v===M,set(e){e?(E&&0!==Object.keys(E).length||(A=!0),v=M):(A=!1,v=U)}});const N={};function C(e,r){if(r>d.VARBYTEINT_MAX)return e.destroy(new Error(`Invalid variable byte integer: ${r}`)),!1;let t=N[r];return t||(t=w(r),r<16384&&(N[r]=t)),e.write(t)}function T(e,r){const t=Buffer.byteLength(r);return v(e,t),e.write(r,"utf8")}function P(e,r,t){T(e,r),T(e,t)}function M(e,r){return e.write(E[r])}function U(e,r){const t=I(r);return e.write(t)}function R(e,r){"string"==typeof r?T(e,r):r?(v(e,r.length),e.write(r)):v(e,0)}function L(e,r){if("object"!=typeof r||null!=r.length)return{length:1,write(){D(e,{},0)}};let t=0;function s(r,t){let s=0;switch(d.propertiesTypes[r]){case"byte":if("boolean"!=typeof t)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=2;break;case"int8":if("number"!=typeof t||t<0||t>255)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=2;break;case"binary":if(t&&null===t)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=1+Buffer.byteLength(t)+2;break;case"int16":if("number"!=typeof t||t<0||t>65535)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=3;break;case"int32":if("number"!=typeof t||t<0||t>4294967295)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=5;break;case"var":if("number"!=typeof t||t<0||t>268435455)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=1+Buffer.byteLength(w(t));break;case"string":if("string"!=typeof t)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=3+Buffer.byteLength(t.toString());break;case"pair":if("object"!=typeof t)return e.destroy(new Error(`Invalid ${r}: ${t}`)),!1;s+=Object.getOwnPropertyNames(t).reduce(((e,r)=>{const s=t[r];return Array.isArray(s)?e+=s.reduce(((e,t)=>e+=3+Buffer.byteLength(r.toString())+2+Buffer.byteLength(t.toString())),0):e+=3+Buffer.byteLength(r.toString())+2+Buffer.byteLength(t[r].toString()),e}),0);break;default:return e.destroy(new Error(`Invalid property ${r}: ${t}`)),!1}return s}if(r)for(const e in r){let i=0,n=0;const o=r[e];if(Array.isArray(o))for(let r=0;r<o.length;r++){if(n=s(e,o[r]),!n)return!1;i+=n}else{if(n=s(e,o),!n)return!1;i=n}if(!i)return!1;t+=i}return{length:Buffer.byteLength(w(t))+t,write(){D(e,r,t)}}}function K(e,r,t,s){const i=["reasonString","userProperties"],n=t&&t.properties&&t.properties.maximumPacketSize?t.properties.maximumPacketSize:0;let o=L(e,r);if(n)for(;s+o.length>n;){const t=i.shift();if(!t||!r[t])return!1;delete r[t],o=L(e,r)}return o}function V(e,r,t){switch(d.propertiesTypes[r]){case"byte":e.write(Buffer.from([d.properties[r]])),e.write(Buffer.from([+t]));break;case"int8":e.write(Buffer.from([d.properties[r]])),e.write(Buffer.from([t]));break;case"binary":e.write(Buffer.from([d.properties[r]])),R(e,t);break;case"int16":e.write(Buffer.from([d.properties[r]])),v(e,t);break;case"int32":e.write(Buffer.from([d.properties[r]])),function(e,r){const t=B(r);e.write(t)}(e,t);break;case"var":e.write(Buffer.from([d.properties[r]])),C(e,t);break;case"string":e.write(Buffer.from([d.properties[r]])),T(e,t);break;case"pair":Object.getOwnPropertyNames(t).forEach((s=>{const i=t[s];Array.isArray(i)?i.forEach((t=>{e.write(Buffer.from([d.properties[r]])),P(e,s.toString(),t.toString())})):(e.write(Buffer.from([d.properties[r]])),P(e,s.toString(),i.toString()))}));break;default:return e.destroy(new Error(`Invalid property ${r} value: ${t}`)),!1}}function D(e,r,t){C(e,t);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&null!==r[t]){const s=r[t];if(Array.isArray(s))for(let r=0;r<s.length;r++)V(e,t,s[r]);else V(e,t,s)}}function H(e){return e?e instanceof Buffer?e.length:Buffer.byteLength(e):0}function Q(e){return"string"==typeof e||e instanceof Buffer}var F=k;const q=F,{EventEmitter:x}=e;class j extends x{constructor(){super(),this._array=new Array(20),this._i=0}write(e){return this._array[this._i++]=e,!0}concat(){let e=0;const r=new Array(this._array.length),t=this._array;let s,i=0;for(s=0;s<t.length&&void 0!==t[s];s++)"string"!=typeof t[s]?r[s]=t[s].length:r[s]=Buffer.byteLength(t[s]),e+=r[s];const n=Buffer.allocUnsafe(e);for(s=0;s<t.length&&void 0!==t[s];s++)"string"!=typeof t[s]?(t[s].copy(n,i),i+=r[s]):(n.write(t[s],i),i+=r[s]);return n}destroy(e){e&&this.emit("error",e)}}var W=function(e,r){const t=new j;return q(e,t,r),t.concat()},$=r.parser=l.parser,z=r.generate=W,Y=r.writeToStream=F;export{r as default,z as generate,$ as parser,Y as writeToStream};
